function cov_mi5f9v15d(){var path="/home/azer/Desktop/jenkins/app/monitoringApp/services/taskActivityLog/updateCurrentTaskActivity.service.js";var hash="0e7ffae971ae68d9a7eeb91c1eeb8087e24592a7";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/home/azer/Desktop/jenkins/app/monitoringApp/services/taskActivityLog/updateCurrentTaskActivity.service.js",statementMap:{"0":{start:{line:1,column:13},end:{line:1,column:41}},"1":{start:{line:2,column:22},end:{line:2,column:42}},"2":{start:{line:3,column:19},end:{line:3,column:36}},"3":{start:{line:4,column:21},end:{line:4,column:40}},"4":{start:{line:6,column:37},end:{line:6,column:77}},"5":{start:{line:7,column:15},end:{line:7,column:32}},"6":{start:{line:8,column:25},end:{line:8,column:62}},"7":{start:{line:11,column:18},end:{line:11,column:66}},"8":{start:{line:11,column:38},end:{line:11,column:65}},"9":{start:{line:12,column:2},end:{line:12,column:63}},"10":{start:{line:12,column:45},end:{line:12,column:61}},"11":{start:{line:16,column:2},end:{line:19,column:4}},"12":{start:{line:17,column:15},end:{line:17,column:72}},"13":{start:{line:22,column:2},end:{line:29,column:4}},"14":{start:{line:24,column:6},end:{line:27,column:11}},"15":{start:{line:32,column:0},end:{line:167,column:2}},"16":{start:{line:33,column:2},end:{line:166,column:3}},"17":{start:{line:34,column:24},end:{line:34,column:74}},"18":{start:{line:35,column:18},end:{line:35,column:34}},"19":{start:{line:36,column:22},end:{line:36,column:72}},"20":{start:{line:37,column:20},end:{line:37,column:68}},"21":{start:{line:39,column:20},end:{line:39,column:66}},"22":{start:{line:41,column:23},end:{line:41,column:63}},"23":{start:{line:41,column:52},end:{line:41,column:62}},"24":{start:{line:42,column:28},end:{line:42,column:73}},"25":{start:{line:44,column:27},end:{line:50,column:5}},"26":{start:{line:51,column:20},end:{line:118,column:6}},"27":{start:{line:119,column:33},end:{line:121,column:5}},"28":{start:{line:122,column:18},end:{line:136,column:6}},"29":{start:{line:123,column:31},end:{line:126,column:7}},"30":{start:{line:127,column:32},end:{line:127,column:75}},"31":{start:{line:128,column:28},end:{line:128,column:69}},"32":{start:{line:129,column:6},end:{line:135,column:8}},"33":{start:{line:137,column:4},end:{line:163,column:5}},"34":{start:{line:138,column:25},end:{line:138,column:61}},"35":{start:{line:139,column:6},end:{line:144,column:7}},"36":{start:{line:140,column:8},end:{line:143,column:10}},"37":{start:{line:145,column:6},end:{line:156,column:8}},"38":{start:{line:158,column:6},end:{line:162,column:8}},"39":{start:{line:165,column:4},end:{line:165,column:53}}},fnMap:{"0":{name:"getSystemsWithoutDuplicate",decl:{start:{line:10,column:9},end:{line:10,column:35}},loc:{start:{line:10,column:43},end:{line:13,column:1}},line:10},"1":{name:"(anonymous_1)",decl:{start:{line:11,column:28},end:{line:11,column:29}},loc:{start:{line:11,column:38},end:{line:11,column:65}},line:11},"2":{name:"(anonymous_2)",decl:{start:{line:12,column:35},end:{line:12,column:36}},loc:{start:{line:12,column:45},end:{line:12,column:61}},line:12},"3":{name:"calculateSystemOccurence",decl:{start:{line:15,column:9},end:{line:15,column:33}},loc:{start:{line:15,column:49},end:{line:20,column:1}},line:15},"4":{name:"(anonymous_4)",decl:{start:{line:17,column:4},end:{line:17,column:5}},loc:{start:{line:17,column:15},end:{line:17,column:72}},line:17},"5":{name:"calculateCanceledTasks",decl:{start:{line:21,column:9},end:{line:21,column:31}},loc:{start:{line:21,column:47},end:{line:30,column:1}},line:21},"6":{name:"(anonymous_6)",decl:{start:{line:23,column:4},end:{line:23,column:5}},loc:{start:{line:24,column:6},end:{line:27,column:11}},line:24},"7":{name:"(anonymous_7)",decl:{start:{line:32,column:17},end:{line:32,column:18}},loc:{start:{line:32,column:45},end:{line:167,column:1}},line:32},"8":{name:"(anonymous_8)",decl:{start:{line:41,column:40},end:{line:41,column:41}},loc:{start:{line:41,column:52},end:{line:41,column:62}},line:41},"9":{name:"(anonymous_9)",decl:{start:{line:122,column:43},end:{line:122,column:44}},loc:{start:{line:122,column:53},end:{line:136,column:5}},line:122}},branchMap:{"0":{loc:{start:{line:17,column:15},end:{line:17,column:72}},type:"cond-expr",locations:[{start:{line:17,column:63},end:{line:17,column:68}},{start:{line:17,column:71},end:{line:17,column:72}}],line:17},"1":{loc:{start:{line:24,column:6},end:{line:27,column:11}},type:"cond-expr",locations:[{start:{line:26,column:10},end:{line:26,column:15}},{start:{line:27,column:10},end:{line:27,column:11}}],line:24},"2":{loc:{start:{line:24,column:6},end:{line:25,column:39}},type:"binary-expr",locations:[{start:{line:24,column:6},end:{line:24,column:51}},{start:{line:25,column:6},end:{line:25,column:39}}],line:24},"3":{loc:{start:{line:137,column:4},end:{line:163,column:5}},type:"if",locations:[{start:{line:137,column:4},end:{line:163,column:5}},{start:{line:137,column:4},end:{line:163,column:5}}],line:137},"4":{loc:{start:{line:139,column:6},end:{line:144,column:7}},type:"if",locations:[{start:{line:139,column:6},end:{line:144,column:7}},{start:{line:139,column:6},end:{line:144,column:7}}],line:139}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"0e7ffae971ae68d9a7eeb91c1eeb8087e24592a7"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];{// @ts-ignore
cov_mi5f9v15d=function(){return actualCoverage;};}return actualCoverage;}cov_mi5f9v15d();const Task=(cov_mi5f9v15d().s[0]++,require('../../models/Task'));const systemService=(cov_mi5f9v15d().s[1]++,require('../system'));const mapService=(cov_mi5f9v15d().s[2]++,require('../map'));const shiftService=(cov_mi5f9v15d().s[3]++,require('../shift'));const virtualTasksGeneratorService=(cov_mi5f9v15d().s[4]++,require('../task/virtualTasksGenerator'));const moment=(cov_mi5f9v15d().s[5]++,require('moment'));const saveTaskActivity=(cov_mi5f9v15d().s[6]++,require('./saveTaskActivity.service'));function getSystemsWithoutDuplicate(array){cov_mi5f9v15d().f[0]++;const systems=(cov_mi5f9v15d().s[7]++,array.map(item=>{cov_mi5f9v15d().f[1]++;cov_mi5f9v15d().s[8]++;return JSON.stringify(item.system);}));cov_mi5f9v15d().s[9]++;return[...new Set(systems)].map(item=>{cov_mi5f9v15d().f[2]++;cov_mi5f9v15d().s[10]++;return JSON.parse(item);});}function calculateSystemOccurence(array,system){cov_mi5f9v15d().f[3]++;cov_mi5f9v15d().s[11]++;return array.reduce((a,v)=>{cov_mi5f9v15d().f[4]++;cov_mi5f9v15d().s[12]++;return v.system._id.toString()===system.toString()?(cov_mi5f9v15d().b[0][0]++,a+1):(cov_mi5f9v15d().b[0][1]++,a);},0);}function calculateCanceledTasks(array,system){cov_mi5f9v15d().f[5]++;cov_mi5f9v15d().s[13]++;return array.reduce((a,v)=>{cov_mi5f9v15d().f[6]++;cov_mi5f9v15d().s[14]++;return(cov_mi5f9v15d().b[2][0]++,v.system._id.toString()===system.toString())&&(cov_mi5f9v15d().b[2][1]++,v.state.toString()==='Canceled')?(cov_mi5f9v15d().b[1][0]++,a+1):(cov_mi5f9v15d().b[1][1]++,a);},0);}cov_mi5f9v15d().s[15]++;module.exports=async(timeZone,userId)=>{cov_mi5f9v15d().f[7]++;cov_mi5f9v15d().s[16]++;try{const shiftResult=(cov_mi5f9v15d().s[17]++,await shiftService.getShiftByUserIDService(userId));const shift=(cov_mi5f9v15d().s[18]++,shiftResult.data);const startDate=(cov_mi5f9v15d().s[19]++,moment(shiftResult.data?.startDate).utc().format());const endDate=(cov_mi5f9v15d().s[20]++,moment(shiftResult.data?.endDate).utc().format());const systems=(cov_mi5f9v15d().s[21]++,await systemService.getSystemsForMapsService());// Array of system IDs
const systemsIDs=(cov_mi5f9v15d().s[22]++,systems.data.map(system=>{cov_mi5f9v15d().f[8]++;cov_mi5f9v15d().s[23]++;return system._id;}));const mapsFromSystems=(cov_mi5f9v15d().s[24]++,await mapService.getMapsBySystems(systemsIDs));//  GeneratedTasks == total tasks
const generatedTasks=(cov_mi5f9v15d().s[25]++,virtualTasksGeneratorService(mapsFromSystems.data,startDate,endDate,userId,timeZone));const dbTasks=(cov_mi5f9v15d().s[26]++,await Task.aggregate([{$match:{$and:[{estimatedStart:{$lt:new Date(endDate)}},{estimatedStart:{$gt:new Date(startDate)}}]}},{$project:{_id:1,system:1,state:1}},{$lookup:{from:'systems',localField:'system',foreignField:'_id',as:'system'}},{$unwind:{path:'$system'}},{$lookup:{from:'customers',localField:'system.customer',foreignField:'_id',as:'customer'}},{$unwind:{path:'$customer'}},{$set:{'customer.name':'$customer.label',taskId:'$_id'}},{$project:{_id:0,'customer._id':1,'customer.name':1,'system._id':1,'system.name':1,state:1,taskId:1}}]));const uniqueGeneratedTasks=(cov_mi5f9v15d().s[27]++,getSystemsWithoutDuplicate(generatedTasks.data));const total=(cov_mi5f9v15d().s[28]++,uniqueGeneratedTasks.map(item=>{cov_mi5f9v15d().f[9]++;const virtualOccurence=(cov_mi5f9v15d().s[29]++,calculateSystemOccurence(generatedTasks.data,item._id));const databaseOccurence=(cov_mi5f9v15d().s[30]++,calculateSystemOccurence(dbTasks,item._id));const canceledTasks=(cov_mi5f9v15d().s[31]++,calculateCanceledTasks(dbTasks,item._id));cov_mi5f9v15d().s[32]++;return{systemName:item.name,customerName:item.customer.label,targetTasks:virtualOccurence,createdTasks:databaseOccurence,canceledTasks:canceledTasks};}));cov_mi5f9v15d().s[33]++;if(total.length>0){cov_mi5f9v15d().b[3][0]++;const saveResult=(cov_mi5f9v15d().s[34]++,await saveTaskActivity(total,shift));cov_mi5f9v15d().s[35]++;if(saveResult.status==='error'){cov_mi5f9v15d().b[4][0]++;cov_mi5f9v15d().s[36]++;return{status:'error',message:saveResult.err};}else{cov_mi5f9v15d().b[4][1]++;}cov_mi5f9v15d().s[37]++;return{data:{result:total,shift:{name:shift.name,start:moment(shift.startDate).format('YYYY-MM-DD HH:mm'),end:moment(shift.endDate).format('YYYY-MM-DD HH:mm')}},status:'success',statusCode:200};}else{cov_mi5f9v15d().b[3][1]++;cov_mi5f9v15d().s[38]++;return{err:{message:'No data can be found.'},statusCode:204,status:'success'};}}catch(err){cov_mi5f9v15d().s[39]++;return{err,status:'error',statusCode:400};}};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVwZGF0ZUN1cnJlbnRUYXNrQWN0aXZpdHkuc2VydmljZS5qcyJdLCJuYW1lcyI6WyJUYXNrIiwicmVxdWlyZSIsInN5c3RlbVNlcnZpY2UiLCJtYXBTZXJ2aWNlIiwic2hpZnRTZXJ2aWNlIiwidmlydHVhbFRhc2tzR2VuZXJhdG9yU2VydmljZSIsIm1vbWVudCIsInNhdmVUYXNrQWN0aXZpdHkiLCJnZXRTeXN0ZW1zV2l0aG91dER1cGxpY2F0ZSIsImFycmF5Iiwic3lzdGVtcyIsIm1hcCIsIml0ZW0iLCJKU09OIiwic3RyaW5naWZ5Iiwic3lzdGVtIiwiU2V0IiwicGFyc2UiLCJjYWxjdWxhdGVTeXN0ZW1PY2N1cmVuY2UiLCJyZWR1Y2UiLCJhIiwidiIsIl9pZCIsInRvU3RyaW5nIiwiY2FsY3VsYXRlQ2FuY2VsZWRUYXNrcyIsInN0YXRlIiwibW9kdWxlIiwiZXhwb3J0cyIsInRpbWVab25lIiwidXNlcklkIiwic2hpZnRSZXN1bHQiLCJnZXRTaGlmdEJ5VXNlcklEU2VydmljZSIsInNoaWZ0IiwiZGF0YSIsInN0YXJ0RGF0ZSIsInV0YyIsImZvcm1hdCIsImVuZERhdGUiLCJnZXRTeXN0ZW1zRm9yTWFwc1NlcnZpY2UiLCJzeXN0ZW1zSURzIiwibWFwc0Zyb21TeXN0ZW1zIiwiZ2V0TWFwc0J5U3lzdGVtcyIsImdlbmVyYXRlZFRhc2tzIiwiZGJUYXNrcyIsImFnZ3JlZ2F0ZSIsIiRtYXRjaCIsIiRhbmQiLCJlc3RpbWF0ZWRTdGFydCIsIiRsdCIsIkRhdGUiLCIkZ3QiLCIkcHJvamVjdCIsIiRsb29rdXAiLCJmcm9tIiwibG9jYWxGaWVsZCIsImZvcmVpZ25GaWVsZCIsImFzIiwiJHVud2luZCIsInBhdGgiLCIkc2V0IiwidGFza0lkIiwidW5pcXVlR2VuZXJhdGVkVGFza3MiLCJ0b3RhbCIsInZpcnR1YWxPY2N1cmVuY2UiLCJkYXRhYmFzZU9jY3VyZW5jZSIsImNhbmNlbGVkVGFza3MiLCJzeXN0ZW1OYW1lIiwibmFtZSIsImN1c3RvbWVyTmFtZSIsImN1c3RvbWVyIiwibGFiZWwiLCJ0YXJnZXRUYXNrcyIsImNyZWF0ZWRUYXNrcyIsImxlbmd0aCIsInNhdmVSZXN1bHQiLCJzdGF0dXMiLCJtZXNzYWdlIiwiZXJyIiwicmVzdWx0Iiwic3RhcnQiLCJlbmQiLCJzdGF0dXNDb2RlIl0sIm1hcHBpbmdzIjoic3RMQWVZO3lGQWZaLEtBQU1BLENBQUFBLElBQUkseUJBQUdDLE9BQU8sQ0FBQyxtQkFBRCxDQUFWLENBQVYsQ0FDQSxLQUFNQyxDQUFBQSxhQUFhLHlCQUFHRCxPQUFPLENBQUMsV0FBRCxDQUFWLENBQW5CLENBQ0EsS0FBTUUsQ0FBQUEsVUFBVSx5QkFBR0YsT0FBTyxDQUFDLFFBQUQsQ0FBVixDQUFoQixDQUNBLEtBQU1HLENBQUFBLFlBQVkseUJBQUdILE9BQU8sQ0FBQyxVQUFELENBQVYsQ0FBbEIsQ0FFQSxLQUFNSSxDQUFBQSw0QkFBNEIseUJBQUdKLE9BQU8sQ0FBQywrQkFBRCxDQUFWLENBQWxDLENBQ0EsS0FBTUssQ0FBQUEsTUFBTSx5QkFBR0wsT0FBTyxDQUFDLFFBQUQsQ0FBVixDQUFaLENBQ0EsS0FBTU0sQ0FBQUEsZ0JBQWdCLHlCQUFHTixPQUFPLENBQUMsNEJBQUQsQ0FBVixDQUF0QixDQUVBLFFBQVNPLENBQUFBLDBCQUFULENBQW9DQyxLQUFwQyxDQUEyQyx3QkFDekMsS0FBTUMsQ0FBQUEsT0FBTyx5QkFBR0QsS0FBSyxDQUFDRSxHQUFOLENBQVdDLElBQUQsRUFBVSxxREFBQUMsQ0FBQUEsSUFBSSxDQUFDQyxTQUFMLENBQWVGLElBQUksQ0FBQ0csTUFBcEIsRUFBMkIsQ0FBL0MsQ0FBSCxDQUFiLENBRHlDLHVCQUV6QyxNQUFPLENBQUMsR0FBRyxHQUFJQyxDQUFBQSxHQUFKLENBQVFOLE9BQVIsQ0FBSixFQUFzQkMsR0FBdEIsQ0FBMkJDLElBQUQsRUFBVSxzREFBQUMsQ0FBQUEsSUFBSSxDQUFDSSxLQUFMLENBQVdMLElBQVgsRUFBZ0IsQ0FBcEQsQ0FBUCxDQUNELENBRUQsUUFBU00sQ0FBQUEsd0JBQVQs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UCxDQUFQLENBWUQsQ0FwQkQsSUFvQk8sbURBQ0wsTUFBTyxDQUNMSixHQUFHLENBQUUsQ0FBRUQsT0FBTyxDQUFFLHVCQUFYLENBREEsQ0FFTEssVUFBVSxDQUFFLEdBRlAsQ0FHTE4sTUFBTSxDQUFFLFNBSEgsQ0FBUCxDQUtELENBQ0YsQ0FBQyxNQUFPRSxHQUFQLENBQVkseUJBQ1osTUFBTyxDQUFFQSxHQUFGLENBQU9GLE1BQU0sQ0FBRSxPQUFmLENBQXdCTSxVQUFVLENBQUUsR0FBcEMsQ0FBUCxDQUNELENBQ0YsQ0F2SUQiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBUYXNrID0gcmVxdWlyZSgnLi4vLi4vbW9kZWxzL1Rhc2snKTtcbmNvbnN0IHN5c3RlbVNlcnZpY2UgPSByZXF1aXJlKCcuLi9zeXN0ZW0nKTtcbmNvbnN0IG1hcFNlcnZpY2UgPSByZXF1aXJlKCcuLi9tYXAnKTtcbmNvbnN0IHNoaWZ0U2VydmljZSA9IHJlcXVpcmUoJy4uL3NoaWZ0Jyk7XG5cbmNvbnN0IHZpcnR1YWxUYXNrc0dlbmVyYXRvclNlcnZpY2UgPSByZXF1aXJlKCcuLi90YXNrL3ZpcnR1YWxUYXNrc0dlbmVyYXRvcicpO1xuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XG5jb25zdCBzYXZlVGFza0FjdGl2aXR5ID0gcmVxdWlyZSgnLi9zYXZlVGFza0FjdGl2aXR5LnNlcnZpY2UnKTtcblxuZnVuY3Rpb24gZ2V0U3lzdGVtc1dpdGhvdXREdXBsaWNhdGUoYXJyYXkpIHtcbiAgY29uc3Qgc3lzdGVtcyA9IGFycmF5Lm1hcCgoaXRlbSkgPT4gSlNPTi5zdHJpbmdpZnkoaXRlbS5zeXN0ZW0pKTtcbiAgcmV0dXJuIFsuLi5uZXcgU2V0KHN5c3RlbXMpXS5tYXAoKGl0ZW0pID0+IEpTT04ucGFyc2UoaXRlbSkpO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVTeXN0ZW1PY2N1cmVuY2UoYXJyYXksIHN5c3RlbSkge1xuICByZXR1cm4gYXJyYXkucmVkdWNlKFxuICAgIChhLCB2KSA9PiAodi5zeXN0ZW0uX2lkLnRvU3RyaW5nKCkgPT09IHN5c3RlbS50b1N0cmluZygpID8gYSArIDEgOiBhKSxcbiAgICAwXG4gICk7XG59XG5mdW5jdGlvbiBjYWxjdWxhdGVDYW5jZWxlZFRhc2tzKGFycmF5LCBzeXN0ZW0pIHtcbiAgcmV0dXJuIGFycmF5LnJlZHVjZShcbiAgICAoYSwgdikgPT5cbiAgICAgIHYuc3lzdGVtLl9pZC50b1N0cmluZygpID09PSBzeXN0ZW0udG9TdHJpbmcoKSAmJlxuICAgICAgdi5zdGF0ZS50b1N0cmluZygpID09PSAnQ2FuY2VsZWQnXG4gICAgICAgID8gYSArIDFcbiAgICAgICAgOiBhLFxuICAgIDBcbiAgKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyAodGltZVpvbmUsIHVzZXJJZCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHNoaWZ0UmVzdWx0ID0gYXdhaXQgc2hpZnRTZXJ2aWNlLmdldFNoaWZ0QnlVc2VySURTZXJ2aWNlKHVzZXJJZCk7XG4gICAgY29uc3Qgc2hpZnQgPSBzaGlmdFJlc3VsdC5kYXRhO1xuICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG1vbWVudChzaGlmdFJlc3VsdC5kYXRhPy5zdGFydERhdGUpLnV0YygpLmZvcm1hdCgpO1xuICAgIGNvbnN0IGVuZERhdGUgPSBtb21lbnQoc2hpZnRSZXN1bHQuZGF0YT8uZW5kRGF0ZSkudXRjKCkuZm9ybWF0KCk7XG5cbiAgICBjb25zdCBzeXN0ZW1zID0gYXdhaXQgc3lzdGVtU2VydmljZS5nZXRTeXN0ZW1zRm9yTWFwc1NlcnZpY2UoKTtcbiAgICAvLyBBcnJheSBvZiBzeXN0ZW0gSURzXG4gICAgY29uc3Qgc3lzdGVtc0lEcyA9IHN5c3RlbXMuZGF0YS5tYXAoKHN5c3RlbSkgPT4gc3lzdGVtLl9pZCk7XG4gICAgY29uc3QgbWFwc0Zyb21TeXN0ZW1zID0gYXdhaXQgbWFwU2VydmljZS5nZXRNYXBzQnlTeXN0ZW1zKHN5c3RlbXNJRHMpO1xuICAgIC8vICBHZW5lcmF0ZWRUYXNrcyA9PSB0b3RhbCB0YXNrc1xuICAgIGNvbnN0IGdlbmVyYXRlZFRhc2tzID0gdmlydHVhbFRhc2tzR2VuZXJhdG9yU2VydmljZShcbiAgICAgIG1hcHNGcm9tU3lzdGVtcy5kYXRhLFxuICAgICAgc3RhcnREYXRlLFxuICAgICAgZW5kRGF0ZSxcbiAgICAgIHVzZXJJZCxcbiAgICAgIHRpbWVab25lXG4gICAgKTtcbiAgICBjb25zdCBkYlRhc2tzID0gYXdhaXQgVGFzay5hZ2dyZWdhdGUoW1xuICAgICAge1xuICAgICAgICAkbWF0Y2g6IHtcbiAgICAgICAgICAkYW5kOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGVzdGltYXRlZFN0YXJ0OiB7XG4gICAgICAgICAgICAgICAgJGx0OiBuZXcgRGF0ZShlbmREYXRlKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBlc3RpbWF0ZWRTdGFydDoge1xuICAgICAgICAgICAgICAgICRndDogbmV3IERhdGUoc3RhcnREYXRlKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgXVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICAkcHJvamVjdDoge1xuICAgICAgICAgIF9pZDogMSxcbiAgICAgICAgICBzeXN0ZW06IDEsXG4gICAgICAgICAgc3RhdGU6IDFcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgJGxvb2t1cDoge1xuICAgICAgICAgIGZyb206ICdzeXN0ZW1zJyxcbiAgICAgICAgICBsb2NhbEZpZWxkOiAnc3lzdGVtJyxcbiAgICAgICAgICBmb3JlaWduRmllbGQ6ICdfaWQnLFxuICAgICAgICAgIGFzOiAnc3lzdGVtJ1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICAkdW53aW5kOiB7XG4gICAgICAgICAgcGF0aDogJyRzeXN0ZW0nXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgICRsb29rdXA6IHtcbiAgICAgICAgICBmcm9tOiAnY3VzdG9tZXJzJyxcbiAgICAgICAgICBsb2NhbEZpZWxkOiAnc3lzdGVtLmN1c3RvbWVyJyxcbiAgICAgICAgICBmb3JlaWduRmllbGQ6ICdfaWQnLFxuICAgICAgICAgIGFzOiAnY3VzdG9tZXInXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgICR1bndpbmQ6IHtcbiAgICAgICAgICBwYXRoOiAnJGN1c3RvbWVyJ1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICAkc2V0OiB7XG4gICAgICAgICAgJ2N1c3RvbWVyLm5hbWUnOiAnJGN1c3RvbWVyLmxhYmVsJyxcbiAgICAgICAgICB0YXNrSWQ6ICckX2lkJ1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICAkcHJvamVjdDoge1xuICAgICAgICAgIF9pZDogMCxcbiAgICAgICAgICAnY3VzdG9tZXIuX2lkJzogMSxcbiAgICAgICAgICAnY3VzdG9tZXIubmFtZSc6IDEsXG4gICAgICAgICAgJ3N5c3RlbS5faWQnOiAxLFxuICAgICAgICAgICdzeXN0ZW0ubmFtZSc6IDEsXG4gICAgICAgICAgc3RhdGU6IDEsXG4gICAgICAgICAgdGFza0lkOiAxXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBdKTtcbiAgICBjb25zdCB1bmlxdWVHZW5lcmF0ZWRUYXNrcyA9IGdldFN5c3RlbXNXaXRob3V0RHVwbGljYXRlKFxuICAgICAgZ2VuZXJhdGVkVGFza3MuZGF0YVxuICAgICk7XG4gICAgY29uc3QgdG90YWwgPSB1bmlxdWVHZW5lcmF0ZWRUYXNrcy5tYXAoKGl0ZW0pID0+IHtcbiAgICAgIGNvbnN0IHZpcnR1YWxPY2N1cmVuY2UgPSBjYWxjdWxhdGVTeXN0ZW1PY2N1cmVuY2UoXG4gICAgICAgIGdlbmVyYXRlZFRhc2tzLmRhdGEsXG4gICAgICAgIGl0ZW0uX2lkXG4gICAgICApO1xuICAgICAgY29uc3QgZGF0YWJhc2VPY2N1cmVuY2UgPSBjYWxjdWxhdGVTeXN0ZW1PY2N1cmVuY2UoZGJUYXNrcywgaXRlbS5faWQpO1xuICAgICAgY29uc3QgY2FuY2VsZWRUYXNrcyA9IGNhbGN1bGF0ZUNhbmNlbGVkVGFza3MoZGJUYXNrcywgaXRlbS5faWQpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3lzdGVtTmFtZTogaXRlbS5uYW1lLFxuICAgICAgICBjdXN0b21lck5hbWU6IGl0ZW0uY3VzdG9tZXIubGFiZWwsXG4gICAgICAgIHRhcmdldFRhc2tzOiB2aXJ0dWFsT2NjdXJlbmNlLFxuICAgICAgICBjcmVhdGVkVGFza3M6IGRhdGFiYXNlT2NjdXJlbmNlLFxuICAgICAgICBjYW5jZWxlZFRhc2tzOiBjYW5jZWxlZFRhc2tzXG4gICAgICB9O1xuICAgIH0pO1xuICAgIGlmICh0b3RhbC5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBzYXZlUmVzdWx0ID0gYXdhaXQgc2F2ZVRhc2tBY3Rpdml0eSh0b3RhbCwgc2hpZnQpO1xuICAgICAgaWYgKHNhdmVSZXN1bHQuc3RhdHVzID09PSAnZXJyb3InKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzOiAnZXJyb3InLFxuICAgICAgICAgIG1lc3NhZ2U6IHNhdmVSZXN1bHQuZXJyXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICByZXR1cm4ge1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgcmVzdWx0OiB0b3RhbCxcbiAgICAgICAgICBzaGlmdDoge1xuICAgICAgICAgICAgbmFtZTogc2hpZnQubmFtZSxcbiAgICAgICAgICAgIHN0YXJ0OiBtb21lbnQoc2hpZnQuc3RhcnREYXRlKS5mb3JtYXQoJ1lZWVktTU0tREQgSEg6bW0nKSxcbiAgICAgICAgICAgIGVuZDogbW9tZW50KHNoaWZ0LmVuZERhdGUpLmZvcm1hdCgnWVlZWS1NTS1ERCBISDptbScpXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBzdGF0dXM6ICdzdWNjZXNzJyxcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBlcnI6IHsgbWVzc2FnZTogJ05vIGRhdGEgY2FuIGJlIGZvdW5kLicgfSxcbiAgICAgICAgc3RhdHVzQ29kZTogMjA0LFxuICAgICAgICBzdGF0dXM6ICdzdWNjZXNzJ1xuICAgICAgfTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJldHVybiB7IGVyciwgc3RhdHVzOiAnZXJyb3InLCBzdGF0dXNDb2RlOiA0MDAgfTtcbiAgfVxufTtcbiJdfQ==